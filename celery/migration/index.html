<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://ejucovy.github.io/airlock/celery/migration/" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Migration - Airlock</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Migration";
        var mkdocs_page_input_path = "celery/migration.md";
        var mkdocs_page_url = "/airlock/celery/migration/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> Airlock
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Understanding Airlock</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../understanding/the-problem/">The Problem</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../understanding/core-model/">Core Model (3 Concerns)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../understanding/design-invariants/">Design Invariants</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../understanding/nesting/">Nesting</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../understanding/alternatives/">Alternatives</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Django</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../django/">Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Celery</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../">Overview</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Migration</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#the-challenge">The Challenge</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#choosing-a-strategy">Choosing a Strategy</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#strategy-1-selective-migration-recommended">Strategy 1: Selective Migration (Recommended)</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#pros">Pros</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#cons">Cons</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#strategy-2-blanket-migration">Strategy 2: Blanket Migration</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#pros_1">Pros</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#cons_1">Cons</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#strategy-3-greenfield-new-code">Strategy 3: Greenfield (New Code)</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#comparison">Comparison</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#hybrid-approach">Hybrid Approach</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#common-patterns">Common Patterns</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#pattern-1-start-blanket-finish-selective">Pattern 1: Start Blanket, Finish Selective</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#pattern-2-selective-for-new-blanket-for-old">Pattern 2: Selective for New, Blanket for Old</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#pattern-3-feature-flag-migration">Pattern 3: Feature Flag Migration</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#common-issues">Common Issues</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#issue-noscopeerror-with-legacytaskshim">Issue: NoScopeError with LegacyTaskShim</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#issue-return-value-is-none">Issue: Return value is None</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#issue-warnings-everywhere">Issue: Warnings everywhere</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#recommendation">Recommendation</a>
    </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Extending</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../extending/custom-policies/">Custom Policies</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../extending/custom-executors/">Custom Executors</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../extending/custom-scopes/">Custom Scopes</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">API Reference</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/core/">Core</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/django/">Django</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/celery/">Celery</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/executors/">Executors</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">Airlock</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Celery</li>
      <li class="breadcrumb-item active">Migration</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/ejucovy/airlock/edit/master/docs/celery/migration.md">Edit on ejucovy/airlock</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="migration-guide">Migration Guide<a class="headerlink" href="#migration-guide" title="Permanent link">&para;</a></h1>
<p>How to migrate an existing codebase from direct Celery <code>.delay()</code> calls to airlock.</p>
<h2 id="the-challenge">The Challenge<a class="headerlink" href="#the-challenge" title="Permanent link">&para;</a></h2>
<p>You have code like this scattered everywhere:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">Order</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>        <span class="n">notify_warehouse</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>        <span class="n">send_email</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="c1"># And in views</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="k">def</span><span class="w"> </span><span class="nf">process_order</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">order_id</span><span class="p">):</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="n">order</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="n">analytics</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p>Changing every <code>.delay()</code> to <code>airlock.enqueue()</code> is tedious and error-prone.</p>
<h2 id="choosing-a-strategy">Choosing a Strategy<a class="headerlink" href="#choosing-a-strategy" title="Permanent link">&para;</a></h2>
<p>Consider these questions when deciding how to migrate:</p>
<p><strong>How many <code>.delay()</code> calls do you have?</strong></p>
<ul>
<li>100+ calls: Start with blanket migration for quick coverage</li>
<li>Fewer calls: Use selective migration for more control</li>
</ul>
<p><strong>Is this a new feature or module?</strong></p>
<ul>
<li>Yes: Use greenfield approach with <code>airlock.enqueue()</code> from the start</li>
<li>No: Continue evaluating below</li>
</ul>
<p><strong>How much time can you invest in migration?</strong></p>
<ul>
<li>More time available: Use selective migration for the safest, most controlled approach</li>
<li>Need quick results: Use blanket migration to get immediate benefits</li>
</ul>
<h2 id="strategy-1-selective-migration-recommended">Strategy 1: Selective Migration (Recommended)<a class="headerlink" href="#strategy-1-selective-migration-recommended" title="Permanent link">&para;</a></h2>
<p>Migrate tasks one at a time using <code>LegacyTaskShim</code>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">airlock.integrations.celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">LegacyTaskShim</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="c1"># Apply to tasks you&#39;re migrating</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="n">LegacyTaskShim</span><span class="p">)</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="k">def</span><span class="w"> </span><span class="nf">notify_warehouse</span><span class="p">(</span><span class="n">order_id</span><span class="p">):</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>    <span class="o">...</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="c1"># Old code still works (inside scopes)</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="k">with</span> <span class="n">airlock</span><span class="o">.</span><span class="n">scope</span><span class="p">():</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>    <span class="n">notify_warehouse</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">order_id</span><span class="p">)</span>  <span class="c1"># Routes through airlock, warns</span>
</span></code></pre></div>
<p><strong>Behavior:</strong>
- Inside scope: routes through airlock, returns <code>None</code>
- Outside scope: raises <code>NoScopeError</code>
- Always emits <code>DeprecationWarning</code></p>
<p><strong>Migration path:</strong>
1. Add <code>LegacyTaskShim</code> to one task
2. Ensure all call sites have scopes
3. Replace <code>.delay()</code> with <code>airlock.enqueue()</code> at your leisure
4. Remove <code>LegacyTaskShim</code> when done</p>
<h3 id="pros">Pros<a class="headerlink" href="#pros" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Safe</strong> - Explicit about what's migrated</li>
<li><strong>Controlled</strong> - Migrate critical paths first</li>
<li><strong>Clear</strong> - Easy to see migration progress</li>
<li><strong>Testable</strong> - Test each task individually</li>
</ul>
<h3 id="cons">Cons<a class="headerlink" href="#cons" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Slow</strong> - Must apply shim to each task</li>
<li><strong>Requires scopes</strong> - Raises <code>NoScopeError</code> outside scopes</li>
<li><strong>Incomplete coverage</strong> - Un-shimmed tasks still use old behavior</li>
</ul>
<h2 id="strategy-2-blanket-migration">Strategy 2: Blanket Migration<a class="headerlink" href="#strategy-2-blanket-migration" title="Permanent link">&para;</a></h2>
<p>Intercept ALL tasks globally:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1"># celery.py</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">Celery</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">airlock.integrations.celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">install_global_intercept</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="s1">&#39;myapp&#39;</span><span class="p">)</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="c1"># Patch all tasks at startup</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="n">install_global_intercept</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</span></code></pre></div>
<p><strong>Behavior:</strong>
- Inside scope: routes through airlock, returns <code>None</code>
- Outside scope: passes through to Celery, warns
- Always emits <code>DeprecationWarning</code>
- Wraps all task execution in scopes automatically</p>
<p><strong>Use for:</strong>
- Large codebases with 100s of <code>.delay()</code> calls
- Quick proof-of-concept
- Gradual migration without breaking existing code</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This is a <strong>migration tool</strong>, not steady-state architecture. It monkey-patches Celery globally. Plan to replace <code>.delay()</code> with <code>airlock.enqueue()</code> over time.</p>
</div>
<h3 id="pros_1">Pros<a class="headerlink" href="#pros_1" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Fast</strong> - One line of code</li>
<li><strong>Complete</strong> - Covers all tasks immediately</li>
<li><strong>Graceful</strong> - Works outside scopes (warns, doesn't break)</li>
<li><strong>Auto-wraps execution</strong> - Tasks run in scopes automatically</li>
</ul>
<h3 id="cons_1">Cons<a class="headerlink" href="#cons_1" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Global side effects</strong> - Monkey-patches Celery</li>
<li><strong>Migration tool</strong> - Not intended for steady-state</li>
<li><strong>Less control</strong> - Everything migrated at once</li>
<li><strong>Returns None</strong> - <code>.delay()</code> returns <code>None</code> inside scopes</li>
</ul>
<h2 id="strategy-3-greenfield-new-code">Strategy 3: Greenfield (New Code)<a class="headerlink" href="#strategy-3-greenfield-new-code" title="Permanent link">&para;</a></h2>
<p>Just use <code>airlock.enqueue()</code> from the start:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">airlock</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">Order</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>        <span class="n">airlock</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="n">notify_warehouse</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="c1"># In views (with Django middleware)</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="k">def</span><span class="w"> </span><span class="nf">process_order</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">order_id</span><span class="p">):</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>    <span class="n">order</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>  <span class="c1"># Effects auto-scoped by middleware</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p>No shims, no warnings, no migration needed.</p>
<h2 id="comparison">Comparison<a class="headerlink" href="#comparison" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>Approach</th>
<th>Effort</th>
<th>Risk</th>
<th>Use When</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Selective</strong></td>
<td>Medium</td>
<td>Low</td>
<td>Methodical migration, want control</td>
</tr>
<tr>
<td><strong>Blanket</strong></td>
<td>Low</td>
<td>Medium</td>
<td>Large codebase, need quick win</td>
</tr>
<tr>
<td><strong>Greenfield</strong></td>
<td>Low</td>
<td>None</td>
<td>New project or isolated feature</td>
</tr>
</tbody>
</table>
<h2 id="hybrid-approach">Hybrid Approach<a class="headerlink" href="#hybrid-approach" title="Permanent link">&para;</a></h2>
<p>Use both strategies:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1"># celery.py - Global intercept for most tasks</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="n">install_global_intercept</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">wrap_task_execution</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="c1"># Critical tasks - Explicit shimming for control</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="n">LegacyTaskShim</span><span class="p">)</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="k">def</span><span class="w"> </span><span class="nf">critical_payment_task</span><span class="p">(</span><span class="n">order_id</span><span class="p">):</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>    <span class="o">...</span>
</span></code></pre></div>
<p>This gives:
- Blanket coverage for routine tasks
- Explicit control for critical tasks
- Gradual migration path</p>
<h2 id="common-patterns">Common Patterns<a class="headerlink" href="#common-patterns" title="Permanent link">&para;</a></h2>
<h3 id="pattern-1-start-blanket-finish-selective">Pattern 1: Start Blanket, Finish Selective<a class="headerlink" href="#pattern-1-start-blanket-finish-selective" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1"># Week 1: Install blanket migration</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="n">install_global_intercept</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="c1"># Week 2-4: Add scopes to critical paths</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="k">with</span> <span class="n">airlock</span><span class="o">.</span><span class="n">scope</span><span class="p">():</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>    <span class="n">process_order</span><span class="p">()</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="c1"># Week 5+: Replace .delay() with airlock.enqueue()</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="c1"># Old: task.delay(arg)</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="c1"># New: airlock.enqueue(task, arg)</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a><span class="c1"># Eventually: Remove intercept when all replaced</span>
</span></code></pre></div>
<h3 id="pattern-2-selective-for-new-blanket-for-old">Pattern 2: Selective for New, Blanket for Old<a class="headerlink" href="#pattern-2-selective-for-new-blanket-for-old" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c1"># New feature: Use airlock.enqueue from start</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">new_checkout_flow</span><span class="p">():</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>    <span class="n">airlock</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="n">new_task</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="c1"># Legacy code: Blanket intercept</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="n">install_global_intercept</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="pattern-3-feature-flag-migration">Pattern 3: Feature Flag Migration<a class="headerlink" href="#pattern-3-feature-flag-migration" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c1"># settings.py</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="n">USE_AIRLOCK</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">bool</span><span class="p">(</span><span class="s2">&quot;USE_AIRLOCK&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="c1"># celery.py</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">USE_AIRLOCK</span><span class="p">:</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>    <span class="n">install_global_intercept</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</span></code></pre></div>
<p>Test in staging, roll out gradually.</p>
<h2 id="common-issues">Common Issues<a class="headerlink" href="#common-issues" title="Permanent link">&para;</a></h2>
<h3 id="issue-noscopeerror-with-legacytaskshim">Issue: <code>NoScopeError</code> with <code>LegacyTaskShim</code><a class="headerlink" href="#issue-noscopeerror-with-legacytaskshim" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="n">notify_warehouse</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>  <span class="c1"># NoScopeError!</span>
</span></code></pre></div>
<p><strong>Fix:</strong> <code>LegacyTaskShim</code> requires a scope. Add one:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="k">with</span> <span class="n">airlock</span><span class="o">.</span><span class="n">scope</span><span class="p">():</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>    <span class="n">notify_warehouse</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>  <span class="c1"># Works</span>
</span></code></pre></div>
<p>Or use <code>install_global_intercept()</code> instead (allows outside scopes).</p>
<h3 id="issue-return-value-is-none">Issue: Return value is <code>None</code><a class="headerlink" href="#issue-return-value-is-none" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="n">result</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>  <span class="c1"># AttributeError: &#39;NoneType&#39; has no attribute &#39;get&#39;</span>
</span></code></pre></div>
<p><strong>Why:</strong> Inside scopes, <code>.delay()</code> returns <code>None</code> because dispatch is deferred.</p>
<p><strong>Fix:</strong> Stop relying on <code>AsyncResult</code>. Decouple intent from result tracking. If you need results, use a different pattern (callbacks, database polling, etc.).</p>
<h3 id="issue-warnings-everywhere">Issue: Warnings everywhere<a class="headerlink" href="#issue-warnings-everywhere" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="ne">DeprecationWarning</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">delay</span><span class="p">()</span> <span class="ow">is</span> <span class="n">deprecated</span><span class="p">,</span> <span class="n">use</span> <span class="n">airlock</span><span class="o">.</span><span class="n">enqueue</span><span class="p">()</span>
</span></code></pre></div>
<p><strong>Fix:</strong> This is intentional! Replace <code>.delay()</code> with <code>airlock.enqueue()</code>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="c1"># Old</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="n">task</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="c1"># New</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="n">airlock</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
</span></code></pre></div>
<h2 id="recommendation">Recommendation<a class="headerlink" href="#recommendation" title="Permanent link">&para;</a></h2>
<p><strong>For most teams:</strong> Start with blanket migration, gradually replace <code>.delay()</code> calls.</p>
<p><strong>For small teams/codebases:</strong> Use selective migration for explicit control.</p>
<p><strong>For new code:</strong> Skip migration entirely, use <code>airlock.enqueue()</code> from day 1.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../" class="btn btn-neutral float-left" title="Overview"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../../extending/custom-policies/" class="btn btn-neutral float-right" title="Custom Policies">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/ejucovy/airlock" class="fa fa-code-fork" style="color: #fcfcfc"> ejucovy/airlock</a>
        </span>
    
    
      <span><a href="../" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../../extending/custom-policies/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>

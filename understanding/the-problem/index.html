<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://ejucovy.github.io/airlock/understanding/the-problem/" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>The Problem - Airlock</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "The Problem";
        var mkdocs_page_input_path = "understanding/the-problem.md";
        var mkdocs_page_url = "/airlock/understanding/the-problem/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> Airlock
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Understanding Airlock</span></p>
              <ul class="current">
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">The Problem</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#why-does-airlock-exist-what-problem-does-it-solve">Why does airlock exist? What problem does it solve?</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#stuff-it-all-in-an-airlock">Stuff it all in an airlock</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#what-this-unlocks">What this unlocks</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#do-i-really-need-this">Do I really need this...?</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../core-model/">Core Model (3 Concerns)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../design-invariants/">Design Invariants</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../nesting/">Nesting</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../alternatives/">Alternatives</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Django</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../django/">Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Celery</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../celery/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../celery/migration.md">Migration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Extending</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../extending/custom-policies/">Custom Policies</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../extending/custom-executors/">Custom Executors</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../extending/custom-scopes/">Custom Scopes</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">API Reference</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/core/">Core</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/django/">Django</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/celery/">Celery</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/executors/">Executors</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">Airlock</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Understanding Airlock</li>
      <li class="breadcrumb-item active">The Problem</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/ejucovy/airlock/edit/master/docs/understanding/the-problem.md">Edit on ejucovy/airlock</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="the-problem">The Problem<a class="headerlink" href="#the-problem" title="Permanent link">&para;</a></h1>
<h2 id="why-does-airlock-exist-what-problem-does-it-solve">Why does airlock exist? What problem does it solve?<a class="headerlink" href="#why-does-airlock-exist-what-problem-does-it-solve" title="Permanent link">&para;</a></h2>
<p>Putting side effects deep in the call stack is common but dangerous:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">Order</span><span class="p">:</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;processed&quot;</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>        <span class="n">notify_warehouse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>        <span class="n">send_confirmation_email</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span></code></pre></div>
<p>It's also tempting to centralize "conditional side effect dispatch" in a deep method. Also dangerous!</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">Order</span><span class="p">:</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>        <span class="n">notify_warehouse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;paid&quot;</span><span class="p">:</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>            <span class="n">send_confirmation_email</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>        <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;shipped&quot;</span><span class="p">:</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>            <span class="n">update_tracking_system</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>            <span class="n">send_update_email</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span></code></pre></div>
<p>But <em>why</em> are they dangerous?</p>
<ul>
<li><strong>You can't opt out.</strong> Every scripted creation, fixture load, and migration that calls the method fires the tasks.</li>
<li><strong>It's invisible at the call site.</strong> <code>order.mark_as_paid()</code> looks innocent. You have to know to trace its call stack for side effects.</li>
<li><strong>Testing is miserable.</strong> Mock at the task level (fragile), run a real broker (slow), or <code>CELERY_ALWAYS_EAGER=True</code> (hides async bugs).</li>
<li><strong>Bulk operations explode.</strong> A loop calling <code>save()</code> on 10,000 orders enqueues 10,000 tasks.</li>
<li><strong>Re-entrancy bites.</strong> <code>User.save()</code> calls <code>enrich_from_api.delay(user.id)</code>. That task fetches data, sets <code>user.age</code> and <code>user.income</code>, then calls <code>user.save()</code>... which enqueues <code>enrich_from_api</code> again. Now you're adding flags like <code>_skip_enrich=True</code> and threading them through everywhere. (Or you're diffing against <code>Model.objects.get(pk=self.pk)</code> in every <code>save()</code> and using <code>save(changed_fields=[])</code> as a task dispatcher. Now you have three problems.)</li>
</ul>
<p>The problem isn't <em>where</em> the intent is expressed. It's that <strong>the effects are silent, and escape immediately</strong>.</p>
<h2 id="stuff-it-all-in-an-airlock">Stuff it all in an airlock<a class="headerlink" href="#stuff-it-all-in-an-airlock" title="Permanent link">&para;</a></h2>
<p>With airlock, you express an <em>intent</em> to perform a side effect, but the side effects don't escape until someone lets them out:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">airlock</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">Order</span><span class="p">:</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;processed&quot;</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>        <span class="n">airlock</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="n">notify_warehouse</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>          <span class="c1"># Buffered for later</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>        <span class="n">airlock</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="n">send_confirmation_email</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>   <span class="c1"># Buffered for later</span>
</span></code></pre></div>
<p>Now these methods are a <em>legitimate</em> and <em>safe</em> place to express domain intent:</p>
<ul>
<li><strong>Colocation.</strong> The model knows when it needs side effects. You may want that knowledge to belong here.</li>
<li><strong>DRY.</strong> Every code path that saves an Order expresses the side effects. You can't forget.</li>
<li><strong>Control.</strong> The <em>scope</em> decides what escapes, not the call site.</li>
<li><strong>Visibility.</strong> You can inspect the buffer before it flushes... run a model method and compare before-and-after... great for tests!</li>
<li><strong>Control again.</strong> Define your own nested scopes for surgically stacked policies, or even define multiple execution boundaries.</li>
</ul>
<p>Side effects can be defined close to the source, and still escape in one place.</p>
<h2 id="what-this-unlocks">What this unlocks<a class="headerlink" href="#what-this-unlocks" title="Permanent link">&para;</a></h2>
<p>Without airlock, "enqueue all side effects at the edge" is an important constraint for maintaining predictable timing, auditability, and control. Side effects deep in the call stack are dangerous, so you're forced to pull them out.</p>
<p>With airlock, both patterns are safe:</p>
<ul>
<li><strong>Edge-only</strong>: All enqueues in views/handlers. Explicit, visible at the boundary.</li>
<li><strong>Colocated</strong>: Enqueues near domain logic (<code>save()</code>, signals, service methods). DRY, encapsulated.</li>
</ul>
<p>Choose based on your preferences, not out of necessity.</p>
<h2 id="do-i-really-need-this">Do I really need this...?<a class="headerlink" href="#do-i-really-need-this" title="Permanent link">&para;</a></h2>
<ul>
<li>See <a href="../alternatives/">Alternatives</a></li>
</ul>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../.." class="btn btn-neutral float-left" title="Home"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../core-model/" class="btn btn-neutral float-right" title="Core Model (3 Concerns)">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/ejucovy/airlock" class="fa fa-code-fork" style="color: #fcfcfc"> ejucovy/airlock</a>
        </span>
    
    
      <span><a href="../.." style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../core-model/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
